{% extends 'base.html' %}

{% block content %}
    <div class="w3-row" style="text-align: right; margin-right: 20px; margin-top: 10px;">
        <button class="w3-button w3-teal" onclick="window.location.href='/attendance'">VIEW ATTENDANCE</button>
        <button class="w3-button w3-teal" onclick="window.location.href='/userlist'">VIEW STUDENTS</button>
        <button class="w3-button w3-teal" onclick="window.location.href='/logout'">LOGOUT</button>
    </div>
    
    {% if error %}
    <div class="w3-panel w3-red w3-display-container">
        <span onclick="this.parentElement.style.display='none'"
              class="w3-button w3-large w3-display-topright">&times;</span>
        <h3>Error!</h3>
        <p>{{ error }}</p>
    </div>
    {% endif %}
    
    <div class="w3-row-padding">
        <!-- Left Column: Form Section -->
        <div class="w3-half">
            <div class="w3-container w3-padding w3-round-xlarge w3-card-4">
                <div id="my_camera" style="width:300px; height:150px;margin:auto"></div>
                
                <!-- ACTUAL FORM for submission -->
                <form id="studentForm" method="POST" action="/add_student">
                    <p>
                        <label><b>IDNO</b></label>
                        <input type="text" name="idno" id="idno" class="w3-input" required>
                    </p>
                    <p>
                        <label><b>LASTNAME</b></label>
                        <input type="text" name="lastname" id="lastname" class="w3-input" required>
                    </p>
                    <p>
                        <label><b>FIRSTNAME</b></label>
                        <input type="text" name="firstname" id="firstname" class="w3-input" required>
                    </p>
                    <p>
                        <label><b>COURSE</b></label>
                        <div class="input-container">
                            <select name="course" id="course" class="w3-input" required>
                                <option value="">Select Course</option>
                                <option value="BSIT">BSIT</option>
                                <option value="BSCS">BSCS</option>
                                <option value="BSECE">BSECE</option>
                                <option value="BSCpE">BSCpE</option>
                            </select>
                        </div>
                    </p>
                    <p>
                        <label><b>LEVEL</b></label>
                        <div class="input-container">
                            <select name="level" id="level" class="w3-input" required>
                                <option value="">Select Year Level</option>
                                <option value="1">1st Year</option>
                                <option value="2">2nd Year</option>
                                <option value="3">3rd Year</option>
                                <option value="4">4th Year</option>
                            </select>
                        </div>
                    </p>
                    
                    <!-- Hidden fields for image and QR code -->
                    <input type="hidden" name="image_data" id="image_data">
                    <input type="hidden" name="qr_code_data" id="qr_code_data">
                    
                    <button type="button" class="w3-button w3-light-blue snap-button" onclick="take_snapshot()">SNAP PHOTO</button>
                </form>
            </div>
        </div>

        <!-- Right Column: Display Section -->
        <div class="w3-half">
            <div class="w3-container w3-padding w3-round-xlarge w3-card-4">
                <!-- Container for Image and QR Code -->
                <div class="image-qr-container">
                    <!-- Image Display Section -->
                    <div id="my_result" style="margin-right: 20px; min-height: 150px;">
                        <p class="w3-text-grey">Photo will appear here after taking snapshot</p>
                    </div>
                    <!-- QR Code Section -->
                    <div id="my_qr_code" style="min-height: 150px;">
                        <p class="w3-text-grey">QR Code will appear here</p>
                        <img id="generated_qr_code" src="" alt="QR Code" width="150" height="150" style="display: none;">
                    </div>
                </div>
                
                <!-- Preview Table -->
                <div class="table-container">
                    <table class="w3-table-all" style="margin-top: 20px; text-align: center;">
                        <tr>
                            <td>IDNO</td>
                            <td>:</td>
                            <td><div id="my_idno">-</div></td>
                        </tr>
                        <tr>
                            <td>LASTNAME</td>
                            <td>:</td>
                            <td><div id="my_lastname">-</div></td>
                        </tr>
                        <tr>
                            <td>FIRSTNAME</td>
                            <td>:</td>
                            <td><div id="my_firstname">-</div></td>
                        </tr>
                        <tr>
                            <td>COURSE</td>
                            <td>:</td>
                            <td><div id="my_course">-</div></td>
                        </tr>
                        <tr>
                            <td>LEVEL</td>
                            <td>:</td>
                            <td><div id="my_level">-</div></td>
                        </tr>
                    </table>
                </div>
                
                <!-- Action Buttons -->
                <div class="button-container">
                    <button class="w3-button w3-indigo action-button" onclick="saveStudent()">SAVE STUDENT</button>
                    <button class="w3-button w3-red action-button" onclick="cancelForm()">CANCEL</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .input-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .w3-input {
            padding-right: 30px;
            width: 100%;
        }

        .snap-button {
            display: block;
            margin: 20px auto;
            width: 80%;
        }

        .button-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }

        .action-button {
            width: 40%;
            padding: 15px;
        }

        .table-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        table {
            width: 50%;
        }

        td {
            padding: 10px;
        }

        .w3-table-all {
            margin: auto;
            width: 80%;
        }

        .image-qr-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin-top: 20px;
            gap: 20px;
        }

        #my_result img {
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 200px;
            height: auto;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/webcamjs/1.0.26/webcam.min.js"></script>
    <script>
        // Global variables to store data
        let currentImageData = null;
        let currentQRCodeData = null;
        
        // Configure Webcam
        Webcam.set({
            width: 320,
            height: 240,
            dest_width: 320,
            dest_height: 240,
            image_format: 'jpeg',
            jpeg_quality: 90,
            force_flash: false,
            flip_horiz: true,
            fps: 45
        });

        Webcam.attach('#my_camera');
        
      function take_snapshot() {
    // Validate form fields
    const idno = document.getElementById('idno').value.trim();
    const lastname = document.getElementById('lastname').value.trim();
    const firstname = document.getElementById('firstname').value.trim();
    const course = document.getElementById('course').value;
    const level = document.getElementById('level').value;

    if (!idno || !lastname || !firstname || !course || !level) {
        alert("Please fill in ALL fields before taking a snapshot.");
        return;
    }

    // Take snapshot
    Webcam.snap(function(data_uri) {
        // Store image data
        currentImageData = data_uri;
        
        // Display preview
        document.getElementById('my_result').innerHTML = '<img src="'+data_uri+'"/>';
        
        // Update preview table
        document.getElementById('my_idno').textContent = idno;
        document.getElementById('my_lastname').textContent = lastname;
        document.getElementById('my_firstname').textContent = firstname;
        document.getElementById('my_course').textContent = course;
        document.getElementById('my_level').textContent = level;
        
        // Generate QR Code using a simple text-based method
        const qrData = `${idno},${lastname},${firstname},${course},${level}`;
        
        // Create a canvas for QR code
        const qrCanvas = document.createElement('canvas');
        qrCanvas.width = 150;
        qrCanvas.height = 150;
        const ctx = qrCanvas.getContext('2d');
        
        // Simple QR-like pattern (for demonstration)
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, 150, 150);
        ctx.fillStyle = 'black';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('QR Code:', 75, 40);
        ctx.fillText(idno, 75, 60);
        ctx.fillText(`${lastname}, ${firstname}`, 75, 80);
        ctx.fillText(`${course} - Year ${level}`, 75, 100);
        
        // Convert canvas to data URL
        currentQRCodeData = qrCanvas.toDataURL('image/png');
        
        // Display QR Code
        const qrImg = document.createElement('img');
        qrImg.id = 'generated_qr_code';
        qrImg.src = currentQRCodeData;
        qrImg.width = 150;
        qrImg.height = 150;
        qrImg.alt = 'QR Code';
        qrImg.style.display = 'inline';
        
        document.getElementById('my_qr_code').innerHTML = '';
        document.getElementById('my_qr_code').appendChild(qrImg);
        
        alert("Snapshot taken! Click SAVE STUDENT to save.");
    });
}
        
        function saveStudent() {
            // Get form values
            const idno = document.getElementById('idno').value.trim();
            const lastname = document.getElementById('lastname').value.trim();
            const firstname = document.getElementById('firstname').value.trim();
            const course = document.getElementById('course').value;
            const level = document.getElementById('level').value;

            // Validate
            if (!idno || !lastname || !firstname || !course || !level) {
                alert("Please fill in ALL fields.");
                return;
            }
            
            if (!currentImageData) {
                alert("Please take a snapshot first.");
                return;
            }

            // Show loading
            const saveBtn = document.querySelector('button[onclick="saveStudent()"]');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = "Saving...";
            saveBtn.disabled = true;

            // 1. Save image to server
            fetch('/save_image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    image_data: currentImageData,
                    idno: idno
                })
            })
            .then(response => response.json())
            .then(imageResult => {
                if (!imageResult.success) {
                    throw new Error('Failed to save image');
                }
                
                // 2. Save QR code
                if (currentQRCodeData) {
                    return fetch('/save_qr_code', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            qr_code_url: currentQRCodeData,
                            idno: idno
                        })
                    });
                }
                return { ok: true };
            })
            .then(qrResponse => {
                if (qrResponse && !qrResponse.ok) {
                    throw new Error('Failed to save QR code');
                }
                
                // 3. Submit the form to save student data
                document.getElementById('studentForm').submit();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving student: ' + error.message);
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            });
        }
        
        function cancelForm() {
            if (confirm("Are you sure? All unsaved data will be lost.")) {
                // Reset form
                document.getElementById('studentForm').reset();
                
                // Reset preview
                document.getElementById('my_result').innerHTML = '<p class="w3-text-grey">Photo will appear here after taking snapshot</p>';
                document.getElementById('my_qr_code').innerHTML = '<p class="w3-text-grey">QR Code will appear here</p>';
                
                // Reset preview table
                document.getElementById('my_idno').textContent = '-';
                document.getElementById('my_lastname').textContent = '-';
                document.getElementById('my_firstname').textContent = '-';
                document.getElementById('my_course').textContent = '-';
                document.getElementById('my_level').textContent = '-';
                
                // Reset global variables
                currentImageData = null;
                currentQRCodeData = null;
                
                // Re-attach QR code element
                const qrCode = document.getElementById('generated_qr_code');
                qrCode.style.display = 'none';
                document.getElementById('my_qr_code').appendChild(qrCode);
            }
        }
    </script>
{% endblock %}

