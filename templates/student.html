{% extends 'base.html' %}

{% block content %}
    <div class="w3-row" style="text-align: right; margin-right: 20px; margin-top: 10px;">
        <button class="w3-button w3-teal" onclick="window.location.href='/attendance'">VIEW ATTENDANCE</button>
        <button class="w3-button w3-teal" onclick="window.location.href='/userlist'">VIEW STUDENTS</button>
        <button class="w3-button w3-teal" onclick="window.location.href='/logout'">LOGOUT</button>
    </div>
    
    {% if error %}
    <div class="w3-panel w3-red w3-display-container">
        <span onclick="this.parentElement.style.display='none'"
              class="w3-button w3-large w3-display-topright">&times;</span>
        <h3>Error!</h3>
        <p>{{ error }}</p>
    </div>
    {% endif %}
    
    <div class="w3-row-padding">
        <!-- Left Column: Form Section -->
        <div class="w3-half">
            <div class="w3-container w3-padding w3-round-xlarge w3-card-4">
                <div id="my_camera" style="width:300px; height:150px;margin:auto"></div>
                
                <!-- ACTUAL FORM for submission -->
                <form id="studentForm" method="POST" action="/add_student">
                    <p>
                        <label><b>IDNO</b></label>
                        <input type="text" name="idno" id="idno" class="w3-input" required>
                    </p>
                    <p>
                        <label><b>LASTNAME</b></label>
                        <input type="text" name="lastname" id="lastname" class="w3-input" required>
                    </p>
                    <p>
                        <label><b>FIRSTNAME</b></label>
                        <input type="text" name="firstname" id="firstname" class="w3-input" required>
                    </p>
                    <p>
                        <label><b>COURSE</b></label>
                        <div class="input-container">
                            <select name="course" id="course" class="w3-input" required>
                                <option value="">Select Course</option>
                                <option value="BSIT">BSIT</option>
                                <option value="BSCS">BSCS</option>
                                <option value="BSECE">BSECE</option>
                                <option value="BSCpE">BSCpE</option>
                            </select>
                        </div>
                    </p>
                    <p>
                        <label><b>LEVEL</b></label>
                        <div class="input-container">
                            <select name="level" id="level" class="w3-input" required>
                                <option value="">Select Year Level</option>
                                <option value="1">1st Year</option>
                                <option value="2">2nd Year</option>
                                <option value="3">3rd Year</option>
                                <option value="4">4th Year</option>
                            </select>
                        </div>
                    </p>
                    
                    <!-- Hidden fields for image and QR code -->
                    <input type="hidden" name="image_data" id="image_data">
                    <input type="hidden" name="qr_code_data" id="qr_code_data">
                    
                    <button type="button" class="w3-button w3-light-blue snap-button" onclick="take_snapshot()">SNAP PHOTO</button>
                </form>
            </div>
        </div>

        <!-- Right Column: Display Section -->
        <div class="w3-half">
            <div class="w3-container w3-padding w3-round-xlarge w3-card-4">
                <!-- Container for Image and QR Code -->
                <div class="image-qr-container">
                    <!-- Image Display Section -->
                    <div id="my_result" style="margin-right: 20px; min-height: 150px;">
                        <p class="w3-text-grey">Photo will appear here after taking snapshot</p>
                    </div>
                    <!-- QR Code Section -->
                    <div id="my_qr_code" style="min-height: 150px;">
                        <p class="w3-text-grey">QR Code will appear here</p>
                        <img id="generated_qr_code" src="" alt="QR Code" width="150" height="150" style="display: none;">
                    </div>
                </div>
                
                <!-- Preview Table -->
                <div class="table-container">
                    <table class="w3-table-all" style="margin-top: 20px; text-align: center;">
                        <tr>
                            <td>IDNO</td>
                            <td>:</td>
                            <td><div id="my_idno">-</div></td>
                        </tr>
                        <tr>
                            <td>LASTNAME</td>
                            <td>:</td>
                            <td><div id="my_lastname">-</div></td>
                        </tr>
                        <tr>
                            <td>FIRSTNAME</td>
                            <td>:</td>
                            <td><div id="my_firstname">-</div></td>
                        </tr>
                        <tr>
                            <td>COURSE</td>
                            <td>:</td>
                            <td><div id="my_course">-</div></td>
                        </tr>
                        <tr>
                            <td>LEVEL</td>
                            <td>:</td>
                            <td><div id="my_level">-</div></td>
                        </tr>
                    </table>
                </div>
                
                <!-- Action Buttons -->
                <div class="button-container">
                    <button class="w3-button w3-indigo action-button" onclick="saveStudent()">SAVE STUDENT</button>
                    <button class="w3-button w3-red action-button" onclick="cancelForm()">CANCEL</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .input-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .w3-input {
            padding-right: 30px;
            width: 100%;
        }

        .snap-button {
            display: block;
            margin: 20px auto;
            width: 80%;
        }

        .button-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }

        .action-button {
            width: 40%;
            padding: 15px;
        }

        .table-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        table {
            width: 50%;
        }

        td {
            padding: 10px;
        }

        .w3-table-all {
            margin: auto;
            width: 80%;
        }

        .image-qr-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin-top: 20px;
            gap: 20px;
        }

        #my_result img {
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 200px;
            height: auto;
        }
    </style>

    <!-- In student.html, replace the entire JavaScript section with this: -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/webcamjs/1.0.26/webcam.min.js"></script>

<script>
    let currentImageData = null;
    
    // Configure Webcam
    Webcam.set({
        width: 320,
        height: 240,
        image_format: 'jpeg',
        jpeg_quality: 90,
        flip_horiz: true
    });
    Webcam.attach('#my_camera');
    
    function take_snapshot() {
        const idno = document.getElementById('idno').value.trim();
        const lastname = document.getElementById('lastname').value.trim();
        const firstname = document.getElementById('firstname').value.trim();
        const course = document.getElementById('course').value;
        const level = document.getElementById('level').value;

        if (!idno || !lastname || !firstname || !course || !level) {
            alert("Please fill in ALL fields.");
            return;
        }

        Webcam.snap(function(data_uri) {
            currentImageData = data_uri;
            
            // Display photo
            document.getElementById('my_result').innerHTML = 
                '<img src="'+data_uri+'" style="width:200px; border-radius:8px;">';
            
            // Update table
            document.getElementById('my_idno').textContent = idno;
            document.getElementById('my_lastname').textContent = lastname;
            document.getElementById('my_firstname').textContent = firstname;
            document.getElementById('my_course').textContent = course;
            document.getElementById('my_level').textContent = level;
            
            // Generate QR Code (ORIGINAL STYLE)
            const qrData = `${idno},${lastname},${firstname},${course},${level}`;
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(qrData)}&size=150x150&format=png&margin=10`;
            
            document.getElementById('my_qr_code').innerHTML = 
                `<img id="generated_qr_code" src="${qrCodeUrl}" width="150" height="150" alt="QR Code" 
                      style="border: 1px solid #ddd; border-radius: 5px;">`;
            
            alert("Ready! Click SAVE STUDENT.");
        });
    }
    
    function saveStudent() {
        const idno = document.getElementById('idno').value.trim();
        const lastname = document.getElementById('lastname').value.trim();
        const firstname = document.getElementById('firstname').value.trim();
        const course = document.getElementById('course').value;
        const level = document.getElementById('level').value;

        if (!idno || !lastname || !firstname || !course || !level) {
            alert("Please fill in ALL fields.");
            return;
        }
        
        if (!currentImageData) {
            alert("Please take a snapshot first.");
            return;
        }

        // Get QR code URL
        const qrImg = document.getElementById('generated_qr_code');
        const qrCodeUrl = qrImg ? qrImg.src : '';

        // Submit everything
        const formData = new FormData();
        formData.append('idno', idno);
        formData.append('lastname', lastname);
        formData.append('firstname', firstname);
        formData.append('course', course);
        formData.append('level', level);
        formData.append('image_data', currentImageData);
        formData.append('qr_code_url', qrCodeUrl);

        fetch('/add_student', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    }
    
    function cancelForm() {
        // Reset everything
        document.getElementById('idno').value = '';
        document.getElementById('lastname').value = '';
        document.getElementById('firstname').value = '';
        document.getElementById('course').value = '';
        document.getElementById('level').value = '';
        
        document.getElementById('my_result').innerHTML = 
            '<p class="w3-text-grey">Photo will appear here</p>';
        document.getElementById('my_qr_code').innerHTML = 
            '<p class="w3-text-grey">QR Code will appear here</p>';
            
        document.getElementById('my_idno').textContent = '-';
        document.getElementById('my_lastname').textContent = '-';
        document.getElementById('my_firstname').textContent = '-';
        document.getElementById('my_course').textContent = '-';
        document.getElementById('my_level').textContent = '-';
        
        currentImageData = null;
    }
</script>
{% endblock %}



