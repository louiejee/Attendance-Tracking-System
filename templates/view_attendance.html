{% extends 'base.html' %}

{% block content %}
<style>
    /* ADDED: Delete button styles */
    .delete-btn {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.3s;
    }
    
    .delete-btn:hover {
        background: #c0392b;
    }
    
    .action-cell {
        text-align: center;
    }
</style>

<div class="w3-row" style="text-align: right; margin-right: 20px; margin-top: 10px;">
    <button class="w3-button w3-teal" onclick="window.location.href='/attendance'">VIEW ATTENDANCE</button>
    <button class="w3-button w3-teal" onclick="window.location.href='/add'">+ADD</button>
    <button class="w3-button w3-teal" onclick="window.location.href='/'">LOGOUT</button>
</div>

<div class="w3-container w3-padding w3-round-xlarge w3-card-4" style="margin-top: 20px;">
    <div class="w3-responsive w3-padding">
        <table class="w3-table-all">
            <thead>
                <tr class="w3-light-grey">
                    <th>IDNO</th>
                    <th>LASTNAME</th>
                    <th>FIRSTNAME</th>
                    <th>COURSE</th>
                    <th>LEVEL</th>
                    <th>TIME LOGGED</th>
                    <th class="action-cell">ACTION</th> <!-- ADDED: Action column -->
                </tr>
            </thead>
            <tbody id="student-list">
                <!-- Student records will be displayed here -->
            </tbody>
        </table>
    </div>
</div>

<canvas id="qr-canvas" style="display:none"></canvas>

<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.min.js"></script>

<script>
    // Function to format date and time
    function formatDateTime(dateString) {
        if (!dateString) return 'N/A';
        
        try {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();

            let hours = date.getHours();
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';

            hours = hours % 12;
            hours = hours ? hours : 12; // 0 becomes 12

            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds} ${ampm}`;
        } catch (e) {
            return dateString;
        }
    }

    // ADDED: Function to delete attendance record
    async function deleteAttendance(idno, time_logged, rowElement) {
        if (!confirm(`Are you sure you want to delete attendance for ${idno} at ${formatDateTime(time_logged)}?`)) {
            return;
        }
        
        try {
            const response = await fetch('/delete_attendance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    idno: idno,
                    time_logged: time_logged
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Attendance record deleted successfully!');
                // Remove the row from table
                rowElement.remove();
                // Reload attendance to update counts
                loadAttendance();
            } else {
                alert('Failed to delete attendance: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error deleting attendance:', error);
            alert('Error deleting attendance. Please try again.');
        }
    }

    // Load attendance from server
    function loadAttendance() {
        fetch('/api/attendance')
            .then(response => {
                if (!response.ok) throw new Error('Failed to load attendance');
                return response.json();
            })
            .then(attendanceList => {
                const studentListContainer = document.getElementById('student-list');
                studentListContainer.innerHTML = '';

                if (!attendanceList || attendanceList.length === 0) {
                    studentListContainer.innerHTML = `
                        <tr>
                            <td colspan="7" class="w3-center">No attendance records found</td> <!-- Changed colspan to 7 -->
                        </tr>
                    `;
                    return;
                }

                attendanceList.forEach(function(record, index) {
                    const row = document.createElement('tr');
                    row.id = `attendance-row-${index}`;
                    row.innerHTML = `
                        <td>${record.idno || 'N/A'}</td>
                        <td>${record.lastname || 'N/A'}</td>
                        <td>${record.firstname || 'N/A'}</td>
                        <td>${record.course || 'N/A'}</td>
                        <td>${record.level || 'N/A'}</td>
                        <td>${formatDateTime(record.time_logged)}</td>
                        <td class="action-cell">
                            <button class="delete-btn" 
                                    onclick="deleteAttendance('${record.idno}', '${record.time_logged}', this.parentElement.parentElement)">
                                Delete
                            </button>
                        </td>
                    `;
                    studentListContainer.appendChild(row);
                });
            })
            .catch(error => {
                console.error('Error loading attendance:', error);
                document.getElementById('student-list').innerHTML = `
                    <tr>
                        <td colspan="7" class="w3-center w3-text-red">Error loading attendance records</td> <!-- Changed colspan to 7 -->
                    </tr>
                `;
            });
    }

    // Load attendance on page load
    window.onload = function() {
        loadAttendance();
        // Refresh every 10 seconds to see new scans
        setInterval(loadAttendance, 10000);
    };
</script>

<!-- In your view_attendance.html template -->
<script>
// Function to fetch and display latest attendance
async function loadLatestAttendance() {
    try {
        // Get all attendance records
        const response = await fetch('/get_attendance');
        
        if (!response.ok) {
            throw new Error('Failed to fetch attendance data');
        }
        
        const data = await response.json();
        
        if (data.success && data.attendance.length > 0) {
            // Get the most recent attendance (first in array)
            const latest = data.attendance[0];
            
            // Display the latest attendance
            displayAttendance(latest);
        } else {
            document.getElementById('attendance-container').innerHTML = 
                '<p>No attendance records found. Scan a QR code first.</p>';
        }
        
    } catch (error) {
        console.error('Error loading attendance:', error);
        document.getElementById('attendance-container').innerHTML = 
            `<p style="color: red;">Error: ${error.message}</p>`;
    }
}

// Function to display attendance data
function displayAttendance(record) {
    const container = document.getElementById('attendance-container');
    container.innerHTML = `
        <div class="attendance-card">
            <h3>âœ… Attendance Recorded Successfully!</h3>
            <p><strong>Student ID:</strong> ${record.idno}</p>
            <p><strong>Name:</strong> ${record.lastname}, ${record.firstname}</p>
            <p><strong>Course:</strong> ${record.course}</p>
            <p><strong>Year Level:</strong> ${record.level}</p>
            <p><strong>Time Logged:</strong> ${record.time_logged}</p>
            <p><strong>Status:</strong> <span class="status">PRESENT</span></p>
        </div>
    `;
}

// Load attendance when page loads
document.addEventListener('DOMContentLoaded', loadLatestAttendance);

// Optional: Auto-refresh every 5 seconds to show new scans
setInterval(loadLatestAttendance, 5000);
</script>

{% endblock %}
