{% extends 'base.html' %}

{% block content %}
    <div class="w3-row" style="text-align: right; margin-right: 20px; margin-top: 10px;">
        <button class="w3-button w3-teal" onclick="window.location.href='/attendance'">VIEW ATTENDANCE</button>
        <button class="w3-button w3-teal" onclick="window.location.href='/add'">+ADD</button>
        <button class="w3-button w3-teal" onclick="window.location.href='/'">LOGOUT</button>
    </div>

    <div class="w3-container w3-padding w3-round-xlarge w3-card-4" style="margin-top: 20px;">
        <div class="w3-responsive w3-padding">
            <table class="w3-table-all">
                <thead>
                    <tr class="w3-light-grey">
                        <th>IDNO</th>
                        <th>LASTNAME</th>
                        <th>FIRSTNAME</th>
                        <th>COURSE</th>
                        <th>LEVEL</th>
                        <th>ACTION</th>
                    </tr>
                </thead>
                <tbody id="student-list">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Edit Form Modal -->
    <div id="edit-form-container" class="w3-modal">
        <div class="w3-modal-content w3-card-4 w3-animate-top w3-padding">
            <span onclick="closeEditForm()" class="w3-button w3-large w3-display-topright">&times;</span>
            <h2>Edit Student</h2>
            <form id="edit-student-form" class="w3-container">
                <label for="edit-lastname">Last Name</label>
                <input type="text" id="edit-lastname" class="w3-input" required>
                <label for="edit-firstname">First Name</label>
                <input type="text" id="edit-firstname" class="w3-input" required>
                <label for="edit-course">Course</label>
                <select id="edit-course" class="w3-select" required>
                    <option value=""></option>
                    <option value="BSIT">BSIT</option>
                    <option value="BSCS">BSCS</option>
                    <option value="BSECE">BSECE</option>
                    <option value="BSCpE">BSCpE</option>
                </select>
                <label for="edit-level">Level</label>
                <select id="edit-level" class="w3-select" required>
                    <option value=""></option>
                    <option value="1">1st Year</option>
                    <option value="2">2nd Year</option>
                    <option value="3">3rd Year</option>
                    <option value="4">4th Year</option>
                </select>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" onclick="saveEdits()" class="w3-button w3-green">Save</button>
                </div>
            </form>
        </div>
    </div>

   <script>
    // Load students from server on page load
    window.onload = function() {
        loadStudentsFromServer();
    };

    function loadStudentsFromServer() {
        fetch('/api/students')
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                return response.json();
            })
            .then(students => {
                const studentListContainer = document.getElementById('student-list');
                studentListContainer.innerHTML = '';

                if (students.length === 0) {
                    studentListContainer.innerHTML = `
                        <tr>
                            <td colspan="6" class="w3-center">No students found</td>
                        </tr>
                    `;
                    return;
                }

                students.forEach(function(student) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${student.idno}</td>
                        <td>${student.lastname}</td>
                        <td>${student.firstname}</td>
                        <td>${student.course}</td>
                        <td>${student.level}</td>
                        <td>
                            <button class="w3-button w3-blue" onclick="editStudent('${student.idno}')">EDIT</button>
                            <button class="w3-button w3-red" onclick="deleteStudent('${student.idno}')">DELETE</button>
                        </td>
                    `;
                    studentListContainer.appendChild(row);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('student-list').innerHTML = `
                    <tr>
                        <td colspan="6" class="w3-center w3-text-red">Error loading students</td>
                    </tr>
                `;
            });
    }

    function deleteStudent(idno) {
        if (!confirm(`Delete student ${idno}?`)) return;
        
        fetch(`/delete_student/${idno}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Student deleted successfully');
                loadStudentsFromServer(); // Refresh the list
            } else {
                alert('Failed to delete student');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting student');
        });
    }

    // Store current student being edited
    let currentEditIdno = null;

    function editStudent(idno) {
        currentEditIdno = idno;
        
        fetch(`/api/student/${idno}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Student not found');
                }
                return response.json();
            })
            .then(student => {
                if (student) {
                    document.getElementById('edit-lastname').value = student.lastname;
                    document.getElementById('edit-firstname').value = student.firstname;
                    document.getElementById('edit-course').value = student.course;
                    document.getElementById('edit-level').value = student.level;
                    document.getElementById('edit-form-container').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error loading student:', error);
                alert('Student not found');
            });
    }

    function saveEdits() {
        if (!currentEditIdno) return;
        
        const updatedData = {
            lastname: document.getElementById('edit-lastname').value,
            firstname: document.getElementById('edit-firstname').value,
            course: document.getElementById('edit-course').value,
            level: document.getElementById('edit-level').value
        };

        fetch(`/update_student/${currentEditIdno}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updatedData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Student updated successfully');
                closeEditForm();
                loadStudentsFromServer();
            } else {
                alert('Failed to update student');
            }
        })
        .catch(error => {
            console.error('Error updating student:', error);
            alert('Error updating student');
        });
    }

    function closeEditForm() {
        document.getElementById('edit-form-container').style.display = 'none';
        currentEditIdno = null;
        
        // Clear form fields
        document.getElementById('edit-lastname').value = '';
        document.getElementById('edit-firstname').value = '';
        document.getElementById('edit-course').value = '';
        document.getElementById('edit-level').value = '';
    }
</script>
{% endblock %}



