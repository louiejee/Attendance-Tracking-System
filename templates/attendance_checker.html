{% extends 'base.html' %}

{% block content %}
    <!-- Main container with flexbox for layout -->
    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <!-- Camera Feed Container on the left -->
        <div id="camera-container" style="flex: 1; display: flex; justify-content: center; align-items: center;">
            <video id="my_camera" width="390" height="320" style="border: 1px solid #000; transform: scaleX(-1);"></video>
        </div>
    </div>

    <div class="container">
        <h1>ATTENDANCE CHECKER</h1>
        
        <!-- QR Scanner Section -->
        <div class="scanner-section">
            <h2>Scan Student QR Code</h2>
            <div id="qr-reader" style="width: 100%; max-width: 500px; margin: 0 auto;"></div>
            <div id="scan-result"></div>
        </div>
        
        <!-- Link to view attendance -->
        <div style="margin-top: 20px;">
            <p>After scanning, you will be redirected to the attendance page.</p>
            <a href="/attendance" class="btn">View Attendance Records</a>
        </div>
    </div>

    <!-- Modal Container -->
    <div id="student-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: #fff; padding: 20px; border-radius: 10px; width: 350px; text-align: center; position: relative;">
            <!-- Close Button -->
            <span id="close-modal" style="position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer;">&times;</span>
            
            <!-- Student Image -->
            <div id="modal-student-image" style="margin-bottom: 15px;">
                <img id="student-image" src="" alt="Student Image" width="150" height="150" style="border-radius: 8px;"/>
            </div>

            <!-- Student Information Table -->
            <table class="w3-table-all" style="margin: 0 auto; text-align: center;">
                <tr>
                    <td>IDNO</td>
                    <td>:</td>
                    <td><div id="my_idno"></div></td>
                </tr>
                <tr>
                    <td>LASTNAME</td>
                    <td>:</td>
                    <td><div id="my_lastname"></div></td>
                </tr>
                <tr>
                    <td>FIRSTNAME</td>
                    <td>:</td>
                    <td><div id="my_firstname"></div></td>
                </tr>
                <tr>
                    <td>COURSE</td>
                    <td>:</td>
                    <td><div id="my_course"></div></td>
                </tr>
                <tr>
                    <td>LEVEL</td>
                    <td>:</td>
                    <td><div id="my_level"></div></td>
                </tr>
            </table>
        </div>
    </div>

    <!-- Include jsQR library -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
    <!-- Include HTML5 QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <script>
        // Function to save attendance and redirect
        async function saveAttendanceToDatabase(idno, lastname, firstname, course, level) {
            // Get current timestamp
            const now = new Date();
            const timeLogged = now.toISOString().slice(0, 19).replace('T', ' ');
            
            // Prepare data to send to server
            const attendanceData = {
                student_info: {
                    idno: idno,
                    lastname: lastname,
                    firstname: firstname,
                    course: course,
                    level: level,
                    time_logged: timeLogged
                }
            };
            
            console.log("Saving attendance for:", idno, "at", timeLogged);
            
            try {
                // Send to server
                const response = await fetch('/scan_qr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(attendanceData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log("✓ Attendance saved successfully!");
                    
                    // ✅ IMPORTANT: Redirect to attendance page
                    setTimeout(() => {
                        window.location.href = '/attendance';
                    }, 1000); // 1 second delay to show modal
                    
                } else {
                    console.error("✗ Failed to save attendance:", data.error);
                    alert("Failed to save attendance. Check console.");
                }
            } catch (error) {
                console.error('Error saving attendance:', error);
                alert("Error saving attendance. Please try again.");
            }
        }

        // Process QR code data from webcam
        function processQRCodeData(qrData) {
            try {
                // Try to parse as JSON first (for new QR codes)
                let idno, lastname, firstname, course, level;
                
                try {
                    const studentInfo = JSON.parse(qrData);
                    idno = studentInfo.idno || studentInfo.studentId;
                    lastname = studentInfo.lastname;
                    firstname = studentInfo.firstname || studentInfo.name;
                    course = studentInfo.course;
                    level = studentInfo.level || studentInfo.year;
                } catch (e) {
                    // If not JSON, try comma-separated format
                    const dataParts = qrData.split(',');
                    if (dataParts.length >= 5) {
                        idno = dataParts[0].trim();
                        lastname = dataParts[1].trim();
                        firstname = dataParts[2].trim();
                        course = dataParts[3].trim();
                        level = dataParts[4].trim();
                    } else {
                        throw new Error("Invalid QR code format");
                    }
                }
                
                if (!idno) {
                    throw new Error("No student ID found in QR code");
                }
                
                // Populate the modal with the student data
                document.getElementById('my_idno').textContent = idno;
                document.getElementById('my_lastname').textContent = lastname || '';
                document.getElementById('my_firstname').textContent = firstname || '';
                document.getElementById('my_course').textContent = course || '';
                document.getElementById('my_level').textContent = level || '';

                // Dynamically set the student image path
                const img = document.getElementById('student-image');
                img.src = `static/image/${idno}.jpg`;
                img.onerror = function() {
                    this.src = 'static/image/default.jpg'; // Fallback image
                };

                // Show the modal
                document.getElementById('student-modal').style.display = 'flex';
                
                // ✅ CRITICAL: SAVE ATTENDANCE TO DATABASE
                saveAttendanceToDatabase(idno, lastname, firstname, course, level);
                
            } catch (error) {
                console.error("QR Code processing error:", error);
                alert("Error: Invalid QR Code - " + error.message);
            }
        }

        // Initialize HTML5 QR Scanner (alternative method)
        function initHTML5QRScanner() {
            const html5QrCode = new Html5Qrcode("qr-reader");
            
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 } 
            };
            
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                onHTML5ScanSuccess,
                onHTML5ScanFailure
            );
            
            console.log("HTML5 QR Scanner initialized");
        }
        
        async function onHTML5ScanSuccess(decodedText) {
            console.log("HTML5 QR Scan result:", decodedText);
            processQRCodeData(decodedText);
        }
        
        function onHTML5ScanFailure(error) {
            console.log(`HTML5 QR Scan failed: ${error}`);
        }

        // Initialize webcam QR scanning
        function initWebcamQRScanner() {
            const video = document.getElementById('my_camera');
            const canvasElement = document.createElement('canvas');
            const canvas = canvasElement.getContext('2d');
            const constraints = {
                video: {
                    facingMode: "environment"
                }
            };

            // Access the webcam
            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    video.srcObject = stream;
                    video.setAttribute('playsinline', true);
                    video.play();
                    startWebcamScanning(video, canvasElement, canvas);
                })
                .catch(function(err) {
                    console.log("Error accessing webcam:", err);
                    document.getElementById('scan-result').innerHTML = 
                        `<p style="color: red;">Webcam error: ${err.message}</p>`;
                });
        }
        
        function startWebcamScanning(video, canvasElement, canvas) {
            // Continuously scan for QR codes
            setInterval(() => {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    // Draw the video frame onto the canvas
                    canvasElement.height = video.videoHeight;
                    canvasElement.width = video.videoWidth;
                    canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);

                    // Get image data from canvas
                    const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);

                    // Scan the image data for QR codes
                    const qrCode = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });

                    if (qrCode) {
                        // If QR code is detected, display the QR code data
                        processQRCodeData(qrCode.data);
                    }
                }
            }, 500); // Scan every 500ms
        }

        // Close Modal Logic
        document.getElementById('close-modal').onclick = function() {
            document.getElementById('student-modal').style.display = 'none';
        };

        // Hide modal when clicking outside the modal content
        window.onclick = function(event) {
            const modal = document.getElementById('student-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };

        // Initialize everything when page loads
        window.onload = function() {
            console.log("Page loaded, initializing scanners...");
            
            // Initialize both scanners
            initWebcamQRScanner();
            initHTML5QRScanner();
        };
    </script>
{% endblock %}
