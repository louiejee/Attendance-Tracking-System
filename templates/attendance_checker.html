{% extends 'base.html' %}

{% block content %}
<style>
    .scanner-container {
        text-align: center;
        padding: 20px;
        max-width: 500px;
        margin: 30px auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    #qr-reader {
        width: 100%;
        max-width: 400px;
        margin: 20px auto;
        border: 2px solid #007bff;
        border-radius: 10px;
        overflow: hidden;
    }
    
    /* MIRROR EFFECT */
    #qr-reader video,
    #qr-reader canvas {
        transform: scaleX(-1) !important;
    }
    
    .result-box {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        display: none;
    }
    
    .success-box {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    
    .error-box {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    
    .time-display {
        font-family: monospace;
        background: #f8f9fa;
        padding: 8px 12px;
        border-radius: 5px;
        margin: 10px 0;
        font-size: 14px;
    }
    
    .student-card {
        background: #e7f3fe;
        border-left: 4px solid #2196F3;
        padding: 15px;
        margin: 15px 0;
        border-radius: 5px;
        text-align: left;
    }
    
    .scan-again-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 15px;
        font-weight: bold;
    }
    
    .scan-again-btn:hover {
        background: #218838;
    }
</style>

<div class="scanner-container">
    <h1>ATTENDANCE CHECKER</h1>
    <p><strong>Scan Student QR Code</strong></p>
    
    <!-- Current Time Display -->
    <div class="time-display">
        Current Time: <span id="current-time">Loading...</span>
    </div>
    
    <!-- QR Scanner -->
    <div id="qr-reader"></div>
    
    <!-- Scan Results -->
    <div id="scan-result" class="result-box"></div>
    
    <!-- Student Info (shown after scan) -->
    <div id="student-info" style="display: none;">
        <div class="student-card">
            <h3 style="color: #155724; margin-top: 0;">✅ Attendance Recorded</h3>
            <p><strong>Student ID:</strong> <span id="info-idno"></span></p>
            <p><strong>Name:</strong> <span id="info-name"></span></p>
            <p><strong>Course:</strong> <span id="info-course"></span></p>
            <p><strong>Year Level:</strong> <span id="info-level"></span></p>
            
            <!-- EXACT TIME LOGGED -->
            <div class="time-display" style="background: #d1ecf1; margin-top: 10px;">
                <strong>Time Logged:</strong> <span id="exact-time"></span>
            </div>
            
            <button onclick="scanAgain()" class="scan-again-btn">Scan Another Student</button>
        </div>
    </div>
    
    <!-- Simple Instructions -->
    <div style="margin-top: 20px; color: #666; font-size: 14px;">
        <p>✓ Point camera at student's QR code</p>
        <p>✓ Make sure QR code is clearly visible</p>
        <p>✓ Camera view is mirrored for easy scanning</p>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
// Simple QR Scanner - No redirects, just scan and show
let scanner = null;
let isScanning = false;

// Update current time
function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', {
        hour12: true,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    const dateString = now.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
    document.getElementById('current-time').textContent = `${dateString} ${timeString}`;
}

// Get EXACT timestamp in readable format
function getExactTimestamp() {
    const now = new Date();
    return {
        iso: now.toISOString(), // For database
        display: now.toLocaleTimeString('en-US', {
            hour12: true,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        }) + ' on ' + now.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        })
    };
}

// Start QR Scanner
function startScanner() {
    scanner = new Html5Qrcode("qr-reader");
    
    const config = { 
        fps: 10, 
        qrbox: { width: 250, height: 250 }
    };
    
    scanner.start(
        { facingMode: "environment" },
        config,
        onScanSuccess,
        onScanFailure
    ).then(() => {
        isScanning = true;
        console.log("Scanner started");
        
        // Apply MIRROR effect to video
        setTimeout(() => {
            const video = document.querySelector('#qr-reader video');
            if (video) {
                video.style.transform = 'scaleX(-1)';
            }
        }, 500);
    }).catch(err => {
        console.error("Scanner error:", err);
        showMessage("Error starting camera. Please allow camera access.", "error");
    });
}

// Handle successful scan
async function onScanSuccess(decodedText) {
    if (!isScanning) return;
    
    // Stop scanner temporarily
    if (scanner) {
        await scanner.stop();
        isScanning = false;
    }
    
    try {
        // Parse QR code data
        let student = {};
        
        // Try JSON format first
        try {
            student = JSON.parse(decodedText);
        } catch(e) {
            // Try comma-separated format: idno,lastname,firstname,course,level
            const parts = decodedText.split(',');
            if (parts.length >= 5) {
                student = {
                    idno: parts[0].trim(),
                    lastname: parts[1].trim(),
                    firstname: parts[2].trim(),
                    course: parts[3].trim(),
                    level: parts[4].trim()
                };
            } else {
                throw new Error("Invalid QR code format");
            }
        }
        
        // Validate required fields
        if (!student.idno) {
            throw new Error("No student ID found");
        }
        
        // Get EXACT timestamp
        const timestamp = getExactTimestamp();
        
        // Show scanning message
        showMessage(`Scanning ${student.firstname || ''} ${student.lastname || ''}...`, "info");
        
        // Save to database
        const saved = await saveAttendance(student, timestamp.iso);
        
        if (saved) {
            // Display success with student info
            displayStudentInfo(student, timestamp.display);
        } else {
            showMessage("Failed to save attendance. Please try again.", "error");
            // Restart scanner
            setTimeout(startScanner, 2000);
        }
        
    } catch (error) {
        showMessage("Error: " + error.message, "error");
        // Restart scanner
        setTimeout(startScanner, 2000);
    }
}

// Display student information
function displayStudentInfo(student, exactTime) {
    // Hide scanner
    document.getElementById('qr-reader').style.display = 'none';
    
    // Hide scan result box
    document.getElementById('scan-result').style.display = 'none';
    
    // Fill student info
    document.getElementById('info-idno').textContent = student.idno;
    document.getElementById('info-name').textContent = 
        `${student.firstname || ''} ${student.lastname || ''}`.trim();
    document.getElementById('info-course').textContent = student.course || 'N/A';
    document.getElementById('info-level').textContent = student.level || 'N/A';
    document.getElementById('exact-time').textContent = exactTime;
    
    // Show student info card
    document.getElementById('student-info').style.display = 'block';
}

// Save attendance to database
async function saveAttendance(student, timestamp) {
    const attendanceData = {
        student_info: {
            idno: student.idno,
            lastname: student.lastname || '',
            firstname: student.firstname || '',
            course: student.course || '',
            level: student.level || '',
            time_logged: timestamp  // EXACT timestamp
        }
    };
    
    try {
        const response = await fetch('/scan_qr', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(attendanceData)
        });
        
        const data = await response.json();
        return data.success === true;
        
    } catch (error) {
        console.error("Save error:", error);
        return false;
    }
}

// Scan another student
function scanAgain() {
    // Hide student info
    document.getElementById('student-info').style.display = 'none';
    
    // Show scanner again
    document.getElementById('qr-reader').style.display = 'block';
    
    // Restart scanner
    startScanner();
}

// Show messages
function showMessage(text, type) {
    const resultDiv = document.getElementById('scan-result');
    resultDiv.textContent = text;
    resultDiv.className = 'result-box';
    resultDiv.classList.add(type === 'error' ? 'error-box' : 'success-box');
    resultDiv.style.display = 'block';
}

// Handle scan failure
function onScanFailure(error) {
    // Just log, don't show error to user
    console.log("Scan attempt:", error);
}

// Initialize everything
document.addEventListener('DOMContentLoaded', function() {
    // Start clock
    updateTime();
    setInterval(updateTime, 1000);
    
    // Start scanner
    startScanner();
});
</script>
{% endblock %}
